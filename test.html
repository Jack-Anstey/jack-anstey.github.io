<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title></title>
    <style>
        body {
            font: 11px sans-serif;
        }

        .axis path,
        .axis line {
            fill: none;
            stroke: #000;
            shape-rendering: crispEdges;
        }

        circle {
            stroke-width: 1;
            stroke: white;
        }

        #legend-svg {
            vertical-align: top;
        }

        #controls {
            padding-top: 10px;
        }
    </style>
</head>
<body>
<div id="container">
    <svg id="main-svg"></svg>
    <svg id="legend-svg"></svg>
</div>
</body>
<script type="text/javascript" src="javascript/legend.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.12/d3.min.js" charset="utf-8"></script>
<script>
    var fullWidth = 600;
    var fullHeight = 400;
    var margin = { top: 20, bottom: 20, left: 30, right: 20 };
    var width = fullWidth - margin.left - margin.right;
    var height = fullHeight - margin.top - margin.bottom;

    var numberPoints = 500;
    // add the legend now
    var legendFullHeight = fullHeight;
    var legendFullWidth = 50;

    var legendMargin = { top: 20, bottom: 20, left: 5, right: 20 };

    // use same margins as main plot
    var legendWidth = legendFullWidth - legendMargin.left - legendMargin.right;
    var legendHeight = legendFullHeight - legendMargin.top - legendMargin.bottom;

    var legendSvg = d3.select('#legend-svg')
        .attr('width', legendFullWidth)
        .attr('height', legendFullHeight)
        .append('g')
        .attr('transform', 'translate(' + legendMargin.left + ',' +
        legendMargin.top + ')');

    updateColourScale(scales['plasma']);

    // attach event listener to control
    d3.select('#scale-select').on('change', function() {
        var val = d3.select(this).node().value;
        updateColourScale(scales[val]);
    });

    // update the colour scale, restyle the plot points and legend
    function updateColourScale(scale) {
        // create colour scale
        var colorScale = d3.scale.linear()
            .domain(linspace(-1, 1, scale.length))
            .range(scale);

        // style points
        d3.selectAll('circle')
            .attr('fill', function(d) {
                return colorScale(d.z);
            });

        // clear current legend
        legendSvg.selectAll('*').remove();

        // append gradient bar
        var gradient = legendSvg.append('defs')
            .append('linearGradient')
            .attr('id', 'gradient')
            .attr('x1', '0%') // bottom
            .attr('y1', '100%')
            .attr('x2', '0%') // to top
            .attr('y2', '0%')
            .attr('spreadMethod', 'pad');

        // programatically generate the gradient for the legend
        // this creates an array of [pct, colour] pairs as stop
        // values for legend
        var pct = linspace(0, 100, scale.length).map(function(d) {
            return Math.round(d) + '%';
        });

        var colourPct = d3.zip(pct, scale);

        colourPct.forEach(function(d) {
            gradient.append('stop')
                .attr('offset', d[0])
                .attr('stop-color', d[1])
                .attr('stop-opacity', 1);
        });

        legendSvg.append('rect')
            .attr('x1', 0)
            .attr('y1', 0)
            .attr('width', legendWidth)
            .attr('height', legendHeight)
            .style('fill', 'url(#gradient)');

        // create a scale and axis for the legend
        var legendScale = d3.scale.linear()
            .domain([-1, 1])
            .range([legendHeight, 0]);
            //.range(['Negative', "Positive"]);
        var legendAxis = d3.svg.axis()
        
            .scale(legendScale)
            .orient("right")
            .tickValues(d3.range(-3, 4))
            .tickFormat(d3.format("d"));

        legendSvg.append("g")
            .attr("class", "legend axis")
            .attr("transform", "translate(" + legendWidth + ", 0)")
            .call(legendAxis);
    }

    function linspace(start, end, n) {
        var out = [];
        var delta = (end - start) / (n - 1);

        var i = 0;
        while(i < (n - 1)) {
            out.push(start + (i * delta));
            i++;
        }

        out.push(end);
        return out;
    }
</script>
</html>